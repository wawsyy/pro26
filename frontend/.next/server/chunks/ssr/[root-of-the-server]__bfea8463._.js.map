{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/fhevm/internal/constants.ts"],"sourcesContent":["export const SDK_CDN_URL =\n  \"https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.umd.cjs\";\n"],"names":[],"mappings":";;;;AAAO,MAAM,cACX","debugId":null}},
    {"offset": {"line": 37, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/fhevm/internal/RelayerSDKLoader.ts"],"sourcesContent":["import { FhevmRelayerSDKType, FhevmWindowType } from \"./fhevmTypes\";\nimport { SDK_CDN_URL } from \"./constants\";\n\ntype TraceType = (message?: unknown, ...optionalParams: unknown[]) => void;\n\nexport class RelayerSDKLoader {\n  private _trace?: TraceType;\n\n  constructor(options: { trace?: TraceType }) {\n    this._trace = options.trace;\n  }\n\n  public isLoaded() {\n    if (typeof window === \"undefined\") {\n      throw new Error(\"RelayerSDKLoader: can only be used in the browser.\");\n    }\n    return isFhevmWindowType(window, this._trace);\n  }\n\n  public load(): Promise<void> {\n    console.log(\"[RelayerSDKLoader] load...\");\n    // Ensure this only runs in the browser\n    if (typeof window === \"undefined\") {\n      console.log(\"[RelayerSDKLoader] window === undefined\");\n      return Promise.reject(\n        new Error(\"RelayerSDKLoader: can only be used in the browser.\")\n      );\n    }\n\n    if (\"relayerSDK\" in window) {\n      if (!isFhevmRelayerSDKType(window.relayerSDK, this._trace)) {\n        console.log(\"[RelayerSDKLoader] window.relayerSDK === undefined\");\n        throw new Error(\"RelayerSDKLoader: Unable to load FHEVM Relayer SDK\");\n      }\n      return Promise.resolve();\n    }\n\n    return new Promise((resolve, reject) => {\n      const existingScript = document.querySelector(\n        `script[src=\"${SDK_CDN_URL}\"]`\n      );\n      if (existingScript) {\n        if (!isFhevmWindowType(window, this._trace)) {\n          reject(\n            new Error(\n              \"RelayerSDKLoader: window object does not contain a valid relayerSDK object.\"\n            )\n          );\n        }\n        resolve();\n        return;\n      }\n\n      const script = document.createElement(\"script\");\n      script.src = SDK_CDN_URL;\n      script.type = \"text/javascript\";\n      script.async = true;\n\n      script.onload = () => {\n        if (!isFhevmWindowType(window, this._trace)) {\n          console.log(\"[RelayerSDKLoader] script onload FAILED...\");\n          reject(\n            new Error(\n              `RelayerSDKLoader: Relayer SDK script has been successfully loaded from ${SDK_CDN_URL}, however, the window.relayerSDK object is invalid.`\n            )\n          );\n        }\n        resolve();\n      };\n\n      script.onerror = () => {\n        console.log(\"[RelayerSDKLoader] script onerror... \");\n        reject(\n          new Error(\n            `RelayerSDKLoader: Failed to load Relayer SDK from ${SDK_CDN_URL}`\n          )\n        );\n      };\n\n      console.log(\"[RelayerSDKLoader] add script to DOM...\");\n      document.head.appendChild(script);\n      console.log(\"[RelayerSDKLoader] script added!\")\n    });\n  }\n}\n\nfunction isFhevmRelayerSDKType(\n  o: unknown,\n  trace?: TraceType\n): o is FhevmRelayerSDKType {\n  if (typeof o === \"undefined\") {\n    trace?.(\"RelayerSDKLoader: relayerSDK is undefined\");\n    return false;\n  }\n  if (o === null) {\n    trace?.(\"RelayerSDKLoader: relayerSDK is null\");\n    return false;\n  }\n  if (typeof o !== \"object\") {\n    trace?.(\"RelayerSDKLoader: relayerSDK is not an object\");\n    return false;\n  }\n  if (!objHasProperty(o, \"initSDK\", \"function\", trace)) {\n    trace?.(\"RelayerSDKLoader: relayerSDK.initSDK is invalid\");\n    return false;\n  }\n  if (!objHasProperty(o, \"createInstance\", \"function\", trace)) {\n    trace?.(\"RelayerSDKLoader: relayerSDK.createInstance is invalid\");\n    return false;\n  }\n  if (!objHasProperty(o, \"SepoliaConfig\", \"object\", trace)) {\n    trace?.(\"RelayerSDKLoader: relayerSDK.SepoliaConfig is invalid\");\n    return false;\n  }\n  if (\"__initialized__\" in o) {\n    if (o.__initialized__ !== true && o.__initialized__ !== false) {\n      trace?.(\"RelayerSDKLoader: relayerSDK.__initialized__ is invalid\");\n      return false;\n    }\n  }\n  return true;\n}\n\nexport function isFhevmWindowType(\n  win: unknown,\n  trace?: TraceType\n): win is FhevmWindowType {\n  if (typeof win === \"undefined\") {\n    trace?.(\"RelayerSDKLoader: window object is undefined\");\n    return false;\n  }\n  if (win === null) {\n    trace?.(\"RelayerSDKLoader: window object is null\");\n    return false;\n  }\n  if (typeof win !== \"object\") {\n    trace?.(\"RelayerSDKLoader: window is not an object\");\n    return false;\n  }\n  if (!(\"relayerSDK\" in win)) {\n    trace?.(\"RelayerSDKLoader: window does not contain 'relayerSDK' property\");\n    return false;\n  }\n  return isFhevmRelayerSDKType(win.relayerSDK);\n}\n\nfunction objHasProperty<\n  T extends object,\n  K extends PropertyKey,\n  V extends string // \"string\", \"number\", etc.\n>(\n  obj: T,\n  propertyName: K,\n  propertyType: V,\n  trace?: TraceType\n): obj is T &\n  Record<\n    K,\n    V extends \"string\"\n      ? string\n      : V extends \"number\"\n      ? number\n      : V extends \"object\"\n      ? object\n      : V extends \"boolean\"\n      ? boolean\n      : V extends \"function\"\n      ? // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        (...args: any[]) => any\n      : unknown\n  > {\n  if (!obj || typeof obj !== \"object\") {\n    return false;\n  }\n\n  if (!(propertyName in obj)) {\n    trace?.(`RelayerSDKLoader: missing ${String(propertyName)}.`);\n    return false;\n  }\n\n  const value = (obj as Record<K, unknown>)[propertyName];\n\n  if (value === null || value === undefined) {\n    trace?.(`RelayerSDKLoader: ${String(propertyName)} is null or undefined.`);\n    return false;\n  }\n\n  if (typeof value !== propertyType) {\n    trace?.(\n      `RelayerSDKLoader: ${String(propertyName)} is not a ${propertyType}.`\n    );\n    return false;\n  }\n\n  return true;\n}\n"],"names":[],"mappings":";;;;;;AACA;;AAIO,MAAM;IACH,OAAmB;IAE3B,YAAY,OAA8B,CAAE;QAC1C,IAAI,CAAC,MAAM,GAAG,QAAQ,KAAK;IAC7B;IAEO,WAAW;QAChB,wCAAmC;YACjC,MAAM,IAAI,MAAM;QAClB;QACA,OAAO,kBAAkB,QAAQ,IAAI,CAAC,MAAM;IAC9C;IAEO,OAAsB;QAC3B,QAAQ,GAAG,CAAC;QACZ,uCAAuC;QACvC,wCAAmC;YACjC,QAAQ,GAAG,CAAC;YACZ,OAAO,QAAQ,MAAM,CACnB,IAAI,MAAM;QAEd;;;IAwDF;AACF;AAEA,SAAS,sBACP,CAAU,EACV,KAAiB;IAEjB,IAAI,OAAO,MAAM,aAAa;QAC5B,QAAQ;QACR,OAAO;IACT;IACA,IAAI,MAAM,MAAM;QACd,QAAQ;QACR,OAAO;IACT;IACA,IAAI,OAAO,MAAM,UAAU;QACzB,QAAQ;QACR,OAAO;IACT;IACA,IAAI,CAAC,eAAe,GAAG,WAAW,YAAY,QAAQ;QACpD,QAAQ;QACR,OAAO;IACT;IACA,IAAI,CAAC,eAAe,GAAG,kBAAkB,YAAY,QAAQ;QAC3D,QAAQ;QACR,OAAO;IACT;IACA,IAAI,CAAC,eAAe,GAAG,iBAAiB,UAAU,QAAQ;QACxD,QAAQ;QACR,OAAO;IACT;IACA,IAAI,qBAAqB,GAAG;QAC1B,IAAI,EAAE,eAAe,KAAK,QAAQ,EAAE,eAAe,KAAK,OAAO;YAC7D,QAAQ;YACR,OAAO;QACT;IACF;IACA,OAAO;AACT;AAEO,SAAS,kBACd,GAAY,EACZ,KAAiB;IAEjB,IAAI,OAAO,QAAQ,aAAa;QAC9B,QAAQ;QACR,OAAO;IACT;IACA,IAAI,QAAQ,MAAM;QAChB,QAAQ;QACR,OAAO;IACT;IACA,IAAI,OAAO,QAAQ,UAAU;QAC3B,QAAQ;QACR,OAAO;IACT;IACA,IAAI,CAAC,CAAC,gBAAgB,GAAG,GAAG;QAC1B,QAAQ;QACR,OAAO;IACT;IACA,OAAO,sBAAsB,IAAI,UAAU;AAC7C;AAEA,SAAS,eAKP,GAAM,EACN,YAAe,EACf,YAAe,EACf,KAAiB;IAiBjB,IAAI,CAAC,OAAO,OAAO,QAAQ,UAAU;QACnC,OAAO;IACT;IAEA,IAAI,CAAC,CAAC,gBAAgB,GAAG,GAAG;QAC1B,QAAQ,CAAC,0BAA0B,EAAE,OAAO,cAAc,CAAC,CAAC;QAC5D,OAAO;IACT;IAEA,MAAM,QAAQ,AAAC,GAA0B,CAAC,aAAa;IAEvD,IAAI,UAAU,QAAQ,UAAU,WAAW;QACzC,QAAQ,CAAC,kBAAkB,EAAE,OAAO,cAAc,sBAAsB,CAAC;QACzE,OAAO;IACT;IAEA,IAAI,OAAO,UAAU,cAAc;QACjC,QACE,CAAC,kBAAkB,EAAE,OAAO,cAAc,UAAU,EAAE,aAAa,CAAC,CAAC;QAEvE,OAAO;IACT;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/fhevm/internal/PublicKeyStorage.ts"],"sourcesContent":["import { openDB, DBSchema, IDBPDatabase } from \"idb\";\n\ntype FhevmStoredPublicKey = {\n  publicKeyId: string;\n  publicKey: Uint8Array;\n};\n\ntype FhevmStoredPublicParams = {\n  publicParamsId: string;\n  publicParams: Uint8Array;\n};\n\ninterface PublicParamsDB extends DBSchema {\n  publicKeyStore: {\n    key: string;\n    value: {\n      acl: `0x${string}`;\n      value: FhevmStoredPublicKey;\n    };\n  };\n  paramsStore: {\n    key: string;\n    value: {\n      acl: `0x${string}`;\n      value: FhevmStoredPublicParams;\n    };\n  };\n}\n\nlet __dbPromise: Promise<IDBPDatabase<PublicParamsDB>> | undefined = undefined;\n\nasync function _getDB(): Promise<IDBPDatabase<PublicParamsDB> | undefined> {\n  if (__dbPromise) {\n    return __dbPromise;\n  }\n  if (typeof window === \"undefined\") {\n    return undefined;\n  }\n  __dbPromise = openDB<PublicParamsDB>(\"fhevm\", 1, {\n    upgrade(db) {\n      if (!db.objectStoreNames.contains(\"paramsStore\")) {\n        db.createObjectStore(\"paramsStore\", { keyPath: \"acl\" });\n      }\n      if (!db.objectStoreNames.contains(\"publicKeyStore\")) {\n        db.createObjectStore(\"publicKeyStore\", { keyPath: \"acl\" });\n      }\n    },\n  });\n  return __dbPromise;\n}\n\ntype FhevmInstanceConfigPublicKey = {\n  data: Uint8Array | null;\n  id: string | null;\n};\n\ntype FhevmInstanceConfigPublicParams = {\n  \"2048\": {\n    publicParamsId: string;\n    publicParams: Uint8Array;\n  };\n};\n\nfunction assertFhevmStoredPublicKey(\n  value: unknown\n): asserts value is FhevmStoredPublicKey | null {\n  if (typeof value !== \"object\") {\n    throw new Error(`FhevmStoredPublicKey must be an object`);\n  }\n  if (value === null) {\n    return;\n  }\n  if (!(\"publicKeyId\" in value)) {\n    throw new Error(`FhevmStoredPublicKey.publicKeyId does not exist`);\n  }\n  if (typeof value.publicKeyId !== \"string\") {\n    throw new Error(`FhevmStoredPublicKey.publicKeyId must be a string`);\n  }\n  if (!(\"publicKey\" in value)) {\n    throw new Error(`FhevmStoredPublicKey.publicKey does not exist`);\n  }\n  if (!(value.publicKey instanceof Uint8Array)) {\n    throw new Error(`FhevmStoredPublicKey.publicKey must be a Uint8Array`);\n  }\n}\n\nfunction assertFhevmStoredPublicParams(\n  value: unknown\n): asserts value is FhevmStoredPublicParams | null {\n  if (typeof value !== \"object\") {\n    throw new Error(`FhevmStoredPublicParams must be an object`);\n  }\n  if (value === null) {\n    return;\n  }\n  if (!(\"publicParamsId\" in value)) {\n    throw new Error(`FhevmStoredPublicParams.publicParamsId does not exist`);\n  }\n  if (typeof value.publicParamsId !== \"string\") {\n    throw new Error(`FhevmStoredPublicParams.publicParamsId must be a string`);\n  }\n  if (!(\"publicParams\" in value)) {\n    throw new Error(`FhevmStoredPublicParams.publicParams does not exist`);\n  }\n  if (!(value.publicParams instanceof Uint8Array)) {\n    throw new Error(\n      `FhevmStoredPublicParams.publicParams must be a Uint8Array`\n    );\n  }\n}\n\nexport async function publicKeyStorageGet(aclAddress: `0x${string}`): Promise<{\n  publicKey?: FhevmInstanceConfigPublicKey;\n  publicParams: FhevmInstanceConfigPublicParams | null;\n}> {\n  const db = await _getDB();\n  if (!db) {\n    return { publicParams: null };\n  }\n\n  let storedPublicKey: FhevmStoredPublicKey | null = null;\n  try {\n    const pk = await db.get(\"publicKeyStore\", aclAddress);\n    if (pk?.value) {\n      assertFhevmStoredPublicKey(pk.value);\n      storedPublicKey = pk.value;\n    }\n  } catch {\n    //\n  }\n\n  let storedPublicParams: FhevmStoredPublicParams | null = null;\n  try {\n    const pp = await db.get(\"paramsStore\", aclAddress);\n    if (pp?.value) {\n      assertFhevmStoredPublicParams(pp.value);\n      storedPublicParams = pp.value;\n    }\n  } catch {\n    //\n  }\n\n  const publicKeyData = storedPublicKey?.publicKey;\n  const publicKeyId = storedPublicKey?.publicKeyId;\n  const publicParams = storedPublicParams\n    ? {\n        \"2048\": storedPublicParams,\n      }\n    : null;\n\n  let publicKey: FhevmInstanceConfigPublicKey | undefined = undefined;\n\n  if (publicKeyId && publicKeyData) {\n    publicKey = {\n      id: publicKeyId,\n      data: publicKeyData,\n    };\n  }\n\n  return {\n    ...(publicKey !== undefined && { publicKey }),\n    publicParams,\n  };\n}\n\nexport async function publicKeyStorageSet(\n  aclAddress: `0x${string}`,\n  publicKey: FhevmStoredPublicKey | null,\n  publicParams: FhevmStoredPublicParams | null\n) {\n  assertFhevmStoredPublicKey(publicKey);\n  assertFhevmStoredPublicParams(publicParams);\n\n  const db = await _getDB();\n  if (!db) {\n    return;\n  }\n\n  if (publicKey) {\n    await db.put(\"publicKeyStore\", { acl: aclAddress, value: publicKey });\n  }\n\n  if (publicParams) {\n    await db.put(\"paramsStore\", { acl: aclAddress, value: publicParams });\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AA6BA,IAAI,cAAiE;AAErE,eAAe;IACb,IAAI,aAAa;QACf,OAAO;IACT;IACA,wCAAmC;QACjC,OAAO;IACT;;;AAYF;AAcA,SAAS,2BACP,KAAc;IAEd,IAAI,OAAO,UAAU,UAAU;QAC7B,MAAM,IAAI,MAAM,CAAC,sCAAsC,CAAC;IAC1D;IACA,IAAI,UAAU,MAAM;QAClB;IACF;IACA,IAAI,CAAC,CAAC,iBAAiB,KAAK,GAAG;QAC7B,MAAM,IAAI,MAAM,CAAC,+CAA+C,CAAC;IACnE;IACA,IAAI,OAAO,MAAM,WAAW,KAAK,UAAU;QACzC,MAAM,IAAI,MAAM,CAAC,iDAAiD,CAAC;IACrE;IACA,IAAI,CAAC,CAAC,eAAe,KAAK,GAAG;QAC3B,MAAM,IAAI,MAAM,CAAC,6CAA6C,CAAC;IACjE;IACA,IAAI,CAAC,CAAC,MAAM,SAAS,YAAY,UAAU,GAAG;QAC5C,MAAM,IAAI,MAAM,CAAC,mDAAmD,CAAC;IACvE;AACF;AAEA,SAAS,8BACP,KAAc;IAEd,IAAI,OAAO,UAAU,UAAU;QAC7B,MAAM,IAAI,MAAM,CAAC,yCAAyC,CAAC;IAC7D;IACA,IAAI,UAAU,MAAM;QAClB;IACF;IACA,IAAI,CAAC,CAAC,oBAAoB,KAAK,GAAG;QAChC,MAAM,IAAI,MAAM,CAAC,qDAAqD,CAAC;IACzE;IACA,IAAI,OAAO,MAAM,cAAc,KAAK,UAAU;QAC5C,MAAM,IAAI,MAAM,CAAC,uDAAuD,CAAC;IAC3E;IACA,IAAI,CAAC,CAAC,kBAAkB,KAAK,GAAG;QAC9B,MAAM,IAAI,MAAM,CAAC,mDAAmD,CAAC;IACvE;IACA,IAAI,CAAC,CAAC,MAAM,YAAY,YAAY,UAAU,GAAG;QAC/C,MAAM,IAAI,MACR,CAAC,yDAAyD,CAAC;IAE/D;AACF;AAEO,eAAe,oBAAoB,UAAyB;IAIjE,MAAM,KAAK,MAAM;IACjB,IAAI,CAAC,IAAI;QACP,OAAO;YAAE,cAAc;QAAK;IAC9B;IAEA,IAAI,kBAA+C;IACnD,IAAI;QACF,MAAM,KAAK,MAAM,GAAG,GAAG,CAAC,kBAAkB;QAC1C,IAAI,IAAI,OAAO;YACb,2BAA2B,GAAG,KAAK;YACnC,kBAAkB,GAAG,KAAK;QAC5B;IACF,EAAE,OAAM;IACN,EAAE;IACJ;IAEA,IAAI,qBAAqD;IACzD,IAAI;QACF,MAAM,KAAK,MAAM,GAAG,GAAG,CAAC,eAAe;QACvC,IAAI,IAAI,OAAO;YACb,8BAA8B,GAAG,KAAK;YACtC,qBAAqB,GAAG,KAAK;QAC/B;IACF,EAAE,OAAM;IACN,EAAE;IACJ;IAEA,MAAM,gBAAgB,iBAAiB;IACvC,MAAM,cAAc,iBAAiB;IACrC,MAAM,eAAe,qBACjB;QACE,QAAQ;IACV,IACA;IAEJ,IAAI,YAAsD;IAE1D,IAAI,eAAe,eAAe;QAChC,YAAY;YACV,IAAI;YACJ,MAAM;QACR;IACF;IAEA,OAAO;QACL,GAAI,cAAc,aAAa;YAAE;QAAU,CAAC;QAC5C;IACF;AACF;AAEO,eAAe,oBACpB,UAAyB,EACzB,SAAsC,EACtC,YAA4C;IAE5C,2BAA2B;IAC3B,8BAA8B;IAE9B,MAAM,KAAK,MAAM;IACjB,IAAI,CAAC,IAAI;QACP;IACF;IAEA,IAAI,WAAW;QACb,MAAM,GAAG,GAAG,CAAC,kBAAkB;YAAE,KAAK;YAAY,OAAO;QAAU;IACrE;IAEA,IAAI,cAAc;QAChB,MAAM,GAAG,GAAG,CAAC,eAAe;YAAE,KAAK;YAAY,OAAO;QAAa;IACrE;AACF","debugId":null}},
    {"offset": {"line": 271, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/fhevm/internal/fhevm.ts"],"sourcesContent":["import { isAddress, Eip1193Provider, JsonRpcProvider } from \"ethers\";\nimport type {\n  FhevmInitSDKOptions,\n  FhevmInitSDKType,\n  FhevmLoadSDKType,\n  FhevmWindowType,\n} from \"./fhevmTypes\";\nimport { isFhevmWindowType, RelayerSDKLoader } from \"./RelayerSDKLoader\";\nimport { publicKeyStorageGet, publicKeyStorageSet } from \"./PublicKeyStorage\";\nimport { FhevmInstance, FhevmInstanceConfig } from \"../fhevmTypes\";\n\nexport class FhevmReactError extends Error {\n  code: string;\n  constructor(code: string, message?: string, options?: ErrorOptions) {\n    super(message, options);\n    this.code = code;\n    this.name = \"FhevmReactError\";\n  }\n}\n\nfunction throwFhevmError(\n  code: string,\n  message?: string,\n  cause?: unknown\n): never {\n  throw new FhevmReactError(code, message, cause ? { cause } : undefined);\n}\n\nconst isFhevmInitialized = (): boolean => {\n  if (!isFhevmWindowType(window, console.log)) {\n    return false;\n  }\n  return window.relayerSDK.__initialized__ === true;\n};\n\nconst fhevmLoadSDK: FhevmLoadSDKType = () => {\n  const loader = new RelayerSDKLoader({ trace: console.log });\n  return loader.load();\n};\n\nconst fhevmInitSDK: FhevmInitSDKType = async (\n  options?: FhevmInitSDKOptions\n) => {\n  if (!isFhevmWindowType(window, console.log)) {\n    throw new Error(\"window.relayerSDK is not available\");\n  }\n  const result = await window.relayerSDK.initSDK(options);\n  window.relayerSDK.__initialized__ = result;\n  if (!result) {\n    throw new Error(\"window.relayerSDK.initSDK failed.\");\n  }\n  return true;\n};\n\nfunction checkIsAddress(a: unknown): a is `0x${string}` {\n  if (typeof a !== \"string\") {\n    return false;\n  }\n  if (!isAddress(a)) {\n    return false;\n  }\n  return true;\n}\n\nexport class FhevmAbortError extends Error {\n  constructor(message = \"FHEVM operation was cancelled\") {\n    super(message);\n    this.name = \"FhevmAbortError\";\n  }\n}\n\ntype FhevmRelayerStatusType =\n  | \"sdk-loading\"\n  | \"sdk-loaded\"\n  | \"sdk-initializing\"\n  | \"sdk-initialized\"\n  | \"creating\";\n\nasync function getChainId(\n  providerOrUrl: Eip1193Provider | string\n): Promise<number> {\n  if (typeof providerOrUrl === \"string\") {\n    const provider = new JsonRpcProvider(providerOrUrl);\n    return Number((await provider.getNetwork()).chainId);\n  }\n  const chainId = await providerOrUrl.request({ method: \"eth_chainId\" });\n  return Number.parseInt(chainId as string, 16);\n}\n\nasync function getWeb3Client(rpcUrl: string) {\n  const rpc = new JsonRpcProvider(rpcUrl);\n  try {\n    const version = await rpc.send(\"web3_clientVersion\", []);\n    return version;\n  } catch (e) {\n    throwFhevmError(\n      \"WEB3_CLIENTVERSION_ERROR\",\n      `The URL ${rpcUrl} is not a Web3 node or is not reachable. Please check the endpoint.`,\n      e\n    );\n  } finally {\n    rpc.destroy();\n  }\n}\n\nasync function tryFetchFHEVMHardhatNodeRelayerMetadata(rpcUrl: string): Promise<\n  | {\n      ACLAddress: `0x${string}`;\n      InputVerifierAddress: `0x${string}`;\n      KMSVerifierAddress: `0x${string}`;\n    }\n  | undefined\n> {\n  const version = await getWeb3Client(rpcUrl);\n  if (\n    typeof version !== \"string\" ||\n    !version.toLowerCase().includes(\"hardhat\")\n  ) {\n    // Not a Hardhat Node\n    return undefined;\n  }\n  try {\n    const metadata = await getFHEVMRelayerMetadata(rpcUrl);\n    if (!metadata || typeof metadata !== \"object\") {\n      return undefined;\n    }\n    if (\n      !(\n        \"ACLAddress\" in metadata &&\n        typeof metadata.ACLAddress === \"string\" &&\n        metadata.ACLAddress.startsWith(\"0x\")\n      )\n    ) {\n      return undefined;\n    }\n    if (\n      !(\n        \"InputVerifierAddress\" in metadata &&\n        typeof metadata.InputVerifierAddress === \"string\" &&\n        metadata.InputVerifierAddress.startsWith(\"0x\")\n      )\n    ) {\n      return undefined;\n    }\n    if (\n      !(\n        \"KMSVerifierAddress\" in metadata &&\n        typeof metadata.KMSVerifierAddress === \"string\" &&\n        metadata.KMSVerifierAddress.startsWith(\"0x\")\n      )\n    ) {\n      return undefined;\n    }\n    return metadata;\n  } catch {\n    // Not a FHEVM Hardhat Node\n    return undefined;\n  }\n}\n\nasync function getFHEVMRelayerMetadata(rpcUrl: string) {\n  const rpc = new JsonRpcProvider(rpcUrl);\n  try {\n    const version = await rpc.send(\"fhevm_relayer_metadata\", []);\n    return version;\n  } catch (e) {\n    throwFhevmError(\n      \"FHEVM_RELAYER_METADATA_ERROR\",\n      `The URL ${rpcUrl} is not a FHEVM Hardhat node or is not reachable. Please check the endpoint.`,\n      e\n    );\n  } finally {\n    rpc.destroy();\n  }\n}\n\ntype MockResolveResult = { isMock: true; chainId: number; rpcUrl: string };\ntype GenericResolveResult = { isMock: false; chainId: number; rpcUrl?: string };\ntype ResolveResult = MockResolveResult | GenericResolveResult;\n\nasync function resolve(\n  providerOrUrl: Eip1193Provider | string,\n  mockChains?: Record<number, string>\n): Promise<ResolveResult> {\n  // Resolve chainId\n  const chainId = await getChainId(providerOrUrl);\n\n  // Resolve rpc url\n  let rpcUrl = typeof providerOrUrl === \"string\" ? providerOrUrl : undefined;\n\n  const _mockChains: Record<number, string> = {\n    31337: \"http://localhost:8545\",\n    ...(mockChains ?? {}),\n  };\n\n  // Help Typescript solver here:\n  if (Object.hasOwn(_mockChains, chainId)) {\n    if (!rpcUrl) {\n      rpcUrl = _mockChains[chainId];\n    }\n\n    return { isMock: true, chainId, rpcUrl };\n  }\n\n  return { isMock: false, chainId, rpcUrl };\n}\n\nexport const createFhevmInstance = async (parameters: {\n  provider: Eip1193Provider | string;\n  mockChains?: Record<number, string>;\n  signal: AbortSignal;\n  onStatusChange?: (status: FhevmRelayerStatusType) => void;\n}): Promise<FhevmInstance> => {\n  const throwIfAborted = () => {\n    if (signal.aborted) throw new FhevmAbortError();\n  };\n\n  const notify = (status: FhevmRelayerStatusType) => {\n    if (onStatusChange) onStatusChange(status);\n  };\n\n  const {\n    signal,\n    onStatusChange,\n    provider: providerOrUrl,\n    mockChains,\n  } = parameters;\n\n  // Resolve chainId\n  const { isMock, rpcUrl, chainId } = await resolve(providerOrUrl, mockChains);\n\n  if (isMock) {\n    // Throws an error if cannot connect or url does not refer to a Web3 client\n    const fhevmRelayerMetadata =\n      await tryFetchFHEVMHardhatNodeRelayerMetadata(rpcUrl);\n\n    if (fhevmRelayerMetadata) {\n      // fhevmRelayerMetadata is defined, which means rpcUrl refers to a FHEVM Hardhat Node\n      notify(\"creating\");\n\n      //////////////////////////////////////////////////////////////////////////\n      // \n      // WARNING!!\n      // ALWAY USE DYNAMIC IMPORT TO AVOID INCLUDING THE ENTIRE FHEVM MOCK LIB \n      // IN THE FINAL PRODUCTION BUNDLE!!\n      // \n      //////////////////////////////////////////////////////////////////////////\n      const fhevmMock = await import(\"./mock/fhevmMock\");\n      const mockInstance = await fhevmMock.fhevmMockCreateInstance({\n        rpcUrl,\n        chainId,\n        metadata: fhevmRelayerMetadata,\n      });\n\n      throwIfAborted();\n\n      return mockInstance;\n    }\n  }\n\n  throwIfAborted();\n\n  if (!isFhevmWindowType(window, console.log)) {\n    notify(\"sdk-loading\");\n\n    // throws an error if failed\n    await fhevmLoadSDK();\n    throwIfAborted();\n\n    notify(\"sdk-loaded\");\n  }\n\n  // notify that state === \"sdk-loaded\"\n\n  if (!isFhevmInitialized()) {\n    notify(\"sdk-initializing\");\n\n    // throws an error if failed\n    await fhevmInitSDK();\n    throwIfAborted();\n\n    notify(\"sdk-initialized\");\n  }\n\n  const relayerSDK = (window as unknown as FhevmWindowType).relayerSDK;\n\n  const aclAddress = relayerSDK.SepoliaConfig.aclContractAddress;\n  if (!checkIsAddress(aclAddress)) {\n    throw new Error(`Invalid address: ${aclAddress}`);\n  }\n\n  const pub = await publicKeyStorageGet(aclAddress);\n  throwIfAborted();\n\n  const config: FhevmInstanceConfig = {\n    ...relayerSDK.SepoliaConfig,\n    network: providerOrUrl,\n    publicKey: pub.publicKey,\n    publicParams: pub.publicParams,\n  };\n\n  // notify that state === \"creating\"\n  notify(\"creating\");\n\n  const instance = await relayerSDK.createInstance(config);\n\n  // Save the key even if aborted\n  await publicKeyStorageSet(\n    aclAddress,\n    instance.getPublicKey(),\n    instance.getPublicParams(2048)\n  );\n\n  throwIfAborted();\n\n  return instance;\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 495, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/fhevm/useFhevm.tsx"],"sourcesContent":["import { ethers } from \"ethers\";\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport type { FhevmInstance } from \"./fhevmTypes\";\nimport { createFhevmInstance } from \"./internal/fhevm\";\n\nfunction _assert(condition: boolean, message?: string): asserts condition {\n  if (!condition) {\n    const m = message ? `Assertion failed: ${message}` : `Assertion failed.`;\n    console.error(m);\n    throw new Error(m);\n  }\n}\n\nexport type FhevmGoState = \"idle\" | \"loading\" | \"ready\" | \"error\";\n\nexport function useFhevm(parameters: {\n  provider: string | ethers.Eip1193Provider | undefined;\n  chainId: number | undefined;\n  enabled?: boolean;\n  initialMockChains?: Readonly<Record<number, string>>;  \n}): {\n  instance: FhevmInstance | undefined;\n  refresh: () => void;\n  error: Error | undefined;\n  status: FhevmGoState;\n} {\n  const { provider, chainId, initialMockChains, enabled = true } = parameters;\n\n  const [instance, _setInstance] = useState<FhevmInstance | undefined>(\n    undefined\n  );\n  const [status, _setStatus] = useState<FhevmGoState>(\"idle\");\n  const [error, _setError] = useState<Error | undefined>(undefined);\n  const [_isRunning, _setIsRunning] = useState<boolean>(enabled);\n  const [_providerChanged, _setProviderChanged] = useState<number>(0);\n  const _abortControllerRef = useRef<AbortController | null>(null);\n  const _providerRef = useRef<string | ethers.Eip1193Provider | undefined>(\n    provider\n  );\n  const _chainIdRef = useRef<number | undefined>(chainId);\n  const _mockChainsRef = useRef<Record<number, string> | undefined>(\n    initialMockChains\n  );\n\n  const refresh = useCallback(() => {\n    // Provider or chainId has changed. Abort immediately\n    if (_abortControllerRef.current) {\n      // Make sure _providerRef.current + _chainIdRef.current are undefined during abort\n      _providerRef.current = undefined;\n      _chainIdRef.current = undefined;\n\n      _abortControllerRef.current.abort();\n      _abortControllerRef.current = null;\n    }\n\n    _providerRef.current = provider;\n    _chainIdRef.current = chainId;\n\n    // Nullify instance immediately\n    _setInstance(undefined);\n    _setError(undefined);\n    _setStatus(\"idle\");\n\n    if (provider !== undefined) {\n      // Force call main useEffect\n      _setProviderChanged((prev) => prev + 1);\n    }\n\n    // Do not modify the running flag.\n  }, [provider, chainId]);\n\n  // Merge in main useEffect!!!\n  useEffect(() => {\n    refresh();\n  }, [refresh]);\n\n  useEffect(() => {\n    _setIsRunning(enabled);\n  }, [enabled]);\n\n  // Main useEffect\n  useEffect(() => {\n    // is _providerRef.current valid here ?\n    // even if the first useEffect is rendered in the same render-cycle ?\n    if (_isRunning === false) {\n      // cancelled\n      console.log(\"cancelled\");\n      if (_abortControllerRef.current) {\n        _abortControllerRef.current.abort();\n        _abortControllerRef.current = null;\n      }\n      // May already be null if provider was changed in the previous render-cycle\n      _setInstance(undefined);\n      _setError(undefined);\n      _setStatus(\"idle\");\n      return;\n    }\n\n    if (_isRunning === true) {\n      if (_providerRef.current === undefined) {\n        // instance should be undefined\n        // this code below should be unecessary\n        _setInstance(undefined);\n        _setError(undefined);\n        _setStatus(\"idle\");\n        return;\n      }\n\n      if (!_abortControllerRef.current) {\n        _abortControllerRef.current = new AbortController();\n      }\n\n      _assert(\n        !_abortControllerRef.current.signal.aborted,\n        \"!controllerRef.current.signal.aborted\"\n      );\n\n      // Keep old instance\n      // Was set to undefined if provider changed\n      _setStatus(\"loading\");\n      _setError(undefined);\n\n      const thisSignal = _abortControllerRef.current.signal;\n      const thisProvider = _providerRef.current;\n      // Can be undefined, if so, call eth_chainId\n      const thisRpcUrlsByChainId = _mockChainsRef.current;\n\n      createFhevmInstance({\n        signal: thisSignal,\n        provider: thisProvider,\n        mockChains: thisRpcUrlsByChainId,\n        onStatusChange: (s) =>\n          console.log(`[useFhevm] createFhevmInstance status changed: ${s}`),\n      })\n        .then((i) => {\n          console.log(`[useFhevm] createFhevmInstance created!`);\n          //console.log(`completed (runId=${thisRunId})...`);\n          if (thisSignal.aborted) return;\n\n          // is there a edge case where the assert below would fail ?\n          // it's not possible to have a _providerRef modified without a prior abort\n          _assert(\n            thisProvider === _providerRef.current,\n            \"thisProvider === _providerRef.current\"\n          );\n\n          _setInstance(i);\n          _setError(undefined);\n          _setStatus(\"ready\");\n        })\n        .catch((e) => {\n          console.log(`Error Was thrown !!! error... ` + e.name);\n          if (thisSignal.aborted) return;\n\n          // it's not possible to have a _providerRef modified without a prior abort\n          _assert(\n            thisProvider === _providerRef.current,\n            \"thisProvider === _providerRef.current\"\n          );\n\n          _setInstance(undefined);\n          _setError(e);\n          _setStatus(\"error\");\n        });\n    }\n  }, [_isRunning, _providerChanged]);\n\n  return { instance, refresh, error, status };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 634, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/hooks/useEthersSigner.ts"],"sourcesContent":["import { useMemo, useState, useEffect } from 'react';\r\nimport { useWalletClient } from 'wagmi';\r\nimport { BrowserProvider, JsonRpcSigner } from 'ethers';\r\n\r\nasync function walletClientToSigner(walletClient: any): Promise<JsonRpcSigner> {\r\n  const { account, chain, transport } = walletClient;\r\n  const network = {\r\n    chainId: chain.id,\r\n    name: chain.name,\r\n    ensAddress: chain.contracts?.ensRegistry?.address,\r\n  };\r\n\r\n  const provider = new BrowserProvider(transport, network);\r\n  const signer = await provider.getSigner(account.address);\r\n  return signer;\r\n}\r\n\r\nexport function useEthersSigner({ chainId }: { chainId?: number } = {}) {\r\n  const { data: walletClient } = useWalletClient({ chainId });\r\n  const [signer, setSigner] = useState<JsonRpcSigner | undefined>(undefined);\r\n\r\n  useEffect(() => {\r\n    if (!walletClient) {\r\n      setSigner(undefined);\r\n      return;\r\n    }\r\n\r\n    walletClientToSigner(walletClient)\r\n      .then(setSigner)\r\n      .catch(() => setSigner(undefined));\r\n  }, [walletClient]);\r\n\r\n  return signer;\r\n}\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,eAAe,qBAAqB,YAAiB;IACnD,MAAM,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,GAAG;IACtC,MAAM,UAAU;QACd,SAAS,MAAM,EAAE;QACjB,MAAM,MAAM,IAAI;QAChB,YAAY,MAAM,SAAS,EAAE,aAAa;IAC5C;IAEA,MAAM,WAAW,IAAI,uMAAe,CAAC,WAAW;IAChD,MAAM,SAAS,MAAM,SAAS,SAAS,CAAC,QAAQ,OAAO;IACvD,OAAO;AACT;AAEO,SAAS,gBAAgB,EAAE,OAAO,EAAwB,GAAG,CAAC,CAAC;IACpE,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,IAAA,+LAAe,EAAC;QAAE;IAAQ;IACzD,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,6NAAQ,EAA4B;IAEhE,IAAA,8NAAS,EAAC;QACR,IAAI,CAAC,cAAc;YACjB,UAAU;YACV;QACF;QAEA,qBAAqB,cAClB,IAAI,CAAC,WACL,KAAK,CAAC,IAAM,UAAU;IAC3B,GAAG;QAAC;KAAa;IAEjB,OAAO;AACT","debugId":null}},
    {"offset": {"line": 729, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/fhevm/FhevmDecryptionSignature.ts"],"sourcesContent":["import { ethers } from \"ethers\";\nimport {\n  EIP712Type,\n  FhevmDecryptionSignatureType,\n  FhevmInstance,\n} from \"./fhevmTypes\";\nimport { GenericStringStorage } from \"./GenericStringStorage\";\n\nfunction _timestampNow(): number {\n  return Math.floor(Date.now() / 1000);\n}\n\nclass FhevmDecryptionSignatureStorageKey {\n  #contractAddresses: `0x${string}`[];\n  #userAddress: `0x${string}`;\n  #publicKey: string | undefined;\n  #key: string;\n\n  constructor(\n    instance: FhevmInstance,\n    contractAddresses: string[],\n    userAddress: string,\n    publicKey?: string\n  ) {\n    if (!ethers.isAddress(userAddress)) {\n      throw new TypeError(`Invalid address ${userAddress}`);\n    }\n\n    const sortedContractAddresses = (\n      contractAddresses as `0x${string}`[]\n    ).sort();\n\n    const emptyEIP712 = instance.createEIP712(\n      publicKey ?? ethers.ZeroAddress,\n      sortedContractAddresses,\n      0,\n      0\n    );\n\n    try {\n      const hash = ethers.TypedDataEncoder.hash(\n        emptyEIP712.domain,\n        { UserDecryptRequestVerification: emptyEIP712.types.UserDecryptRequestVerification },\n        emptyEIP712.message\n      );\n\n      this.#contractAddresses = sortedContractAddresses;\n      this.#userAddress = userAddress as `0x${string}`;\n\n      this.#key = `${userAddress}:${hash}`;\n    } catch (e) {\n      console.log(e);\n      throw e;\n    }\n  }\n\n  get contractAddresses(): `0x${string}`[] {\n    return this.#contractAddresses;\n  }\n\n  get userAddress(): `0x${string}` {\n    return this.#userAddress;\n  }\n\n  get publicKey(): string | undefined {\n    return this.#publicKey;\n  }\n\n  get key(): string {\n    return this.#key;\n  }\n}\n\nexport class FhevmDecryptionSignature {\n  #publicKey: string;\n  #privateKey: string;\n  #signature: string;\n  #startTimestamp: number; // Unix timestamp in seconds\n  #durationDays: number;\n  #userAddress: `0x${string}`;\n  #contractAddresses: `0x${string}`[];\n  #eip712: EIP712Type;\n\n  private constructor(parameters: FhevmDecryptionSignatureType) {\n    if (!FhevmDecryptionSignature.checkIs(parameters)) {\n      throw new TypeError(\"Invalid FhevmDecryptionSignatureType\");\n    }\n    this.#publicKey = parameters.publicKey;\n    this.#privateKey = parameters.privateKey;\n    this.#signature = parameters.signature;\n    this.#startTimestamp = parameters.startTimestamp;\n    this.#durationDays = parameters.durationDays;\n    this.#userAddress = parameters.userAddress;\n    this.#contractAddresses = parameters.contractAddresses;\n    this.#eip712 = parameters.eip712;\n  }\n\n  public get privateKey() {\n    return this.#privateKey;\n  }\n\n  public get publicKey() {\n    return this.#publicKey;\n  }\n\n  public get signature() {\n    return this.#signature;\n  }\n\n  public get contractAddresses() {\n    return this.#contractAddresses;\n  }\n\n  public get startTimestamp() {\n    return this.#startTimestamp;\n  }\n\n  public get durationDays() {\n    return this.#durationDays;\n  }\n\n  public get userAddress() {\n    return this.#userAddress;\n  }\n\n  static checkIs(s: unknown): s is FhevmDecryptionSignatureType {\n    if (!s || typeof s !== \"object\") {\n      return false;\n    }\n    if (!(\"publicKey\" in s && typeof s.publicKey === \"string\")) {\n      return false;\n    }\n    if (!(\"privateKey\" in s && typeof s.privateKey === \"string\")) {\n      return false;\n    }\n    if (!(\"signature\" in s && typeof s.signature === \"string\")) {\n      return false;\n    }\n    if (!(\"startTimestamp\" in s && typeof s.startTimestamp === \"number\")) {\n      return false;\n    }\n    if (!(\"durationDays\" in s && typeof s.durationDays === \"number\")) {\n      return false;\n    }\n    if (!(\"contractAddresses\" in s && Array.isArray(s.contractAddresses))) {\n      return false;\n    }\n    for (let i = 0; i < s.contractAddresses.length; ++i) {\n      if (typeof s.contractAddresses[i] !== \"string\") return false;\n      if (!s.contractAddresses[i].startsWith(\"0x\")) return false;\n    }\n    if (\n      !(\n        \"userAddress\" in s &&\n        typeof s.userAddress === \"string\" &&\n        s.userAddress.startsWith(\"0x\")\n      )\n    ) {\n      return false;\n    }\n    if (!(\"eip712\" in s && typeof s.eip712 === \"object\" && s.eip712 !== null)) {\n      return false;\n    }\n\n    // Partial type check\n    if (!(\"domain\" in s.eip712 && typeof s.eip712.domain === \"object\")) {\n      return false;\n    }\n    if (\n      !(\"primaryType\" in s.eip712 && typeof s.eip712.primaryType === \"string\")\n    ) {\n      return false;\n    }\n    if (!(\"message\" in s.eip712)) {\n      return false;\n    }\n    if (\n      !(\n        \"types\" in s.eip712 &&\n        typeof s.eip712.types === \"object\" &&\n        s.eip712.types !== null\n      )\n    ) {\n      return false;\n    }\n\n    return true;\n  }\n\n  toJSON() {\n    return {\n      publicKey: this.#publicKey,\n      privateKey: this.#privateKey,\n      signature: this.#signature,\n      startTimestamp: this.#startTimestamp,\n      durationDays: this.#durationDays,\n      userAddress: this.#userAddress,\n      contractAddresses: this.#contractAddresses,\n      eip712: this.#eip712,\n    };\n  }\n\n  static fromJSON(json: unknown) {\n    const data = typeof json === \"string\" ? JSON.parse(json) : json;\n    return new FhevmDecryptionSignature(data);\n  }\n\n  equals(s: FhevmDecryptionSignatureType) {\n    return s.signature === this.#signature;\n  }\n\n  isValid(): boolean {\n    return (\n      _timestampNow() < this.#startTimestamp + this.#durationDays * 24 * 60 * 60\n    );\n  }\n\n  async saveToGenericStringStorage(\n    storage: GenericStringStorage,\n    instance: FhevmInstance,\n    withPublicKey: boolean\n  ) {\n    try {\n      const value = JSON.stringify(this);\n\n      const storageKey = new FhevmDecryptionSignatureStorageKey(\n        instance,\n        this.#contractAddresses,\n        this.#userAddress,\n        withPublicKey ? this.#publicKey : undefined\n      );\n      await storage.setItem(storageKey.key, value);\n      console.log(\n        `signature saved! contracts=${this.#contractAddresses.length}`\n      );\n    } catch {\n      console.error(\n        `FhevmDecryptionSignature.saveToGenericStringStorage() failed!`\n      );\n    }\n  }\n\n  static async loadFromGenericStringStorage(\n    storage: GenericStringStorage,\n    instance: FhevmInstance,\n    contractAddresses: string[],\n    userAddress: string,\n    publicKey?: string\n  ): Promise<FhevmDecryptionSignature | null> {\n    try {\n      const storageKey = new FhevmDecryptionSignatureStorageKey(\n        instance,\n        contractAddresses,\n        userAddress,\n        publicKey\n      );\n\n      const result = await storage.getItem(storageKey.key);\n\n      if (!result) {\n        console.warn(`Could not load signature! key=${storageKey.key}`);\n        return null;\n      }\n\n      try {\n        const kps = FhevmDecryptionSignature.fromJSON(result);\n        if (!kps.isValid()) {\n          return null;\n        }\n\n        return kps;\n      } catch {\n        return null;\n      }\n    } catch {\n      console.error(\n        `FhevmDecryptionSignature.loadFromGenericStringStorage() failed!`\n      );\n      return null;\n    }\n  }\n\n  static async new(\n    instance: FhevmInstance,\n    contractAddresses: string[],\n    publicKey: string,\n    privateKey: string,\n    signer: ethers.Signer\n  ): Promise<FhevmDecryptionSignature | null> {\n    try {\n      const userAddress = (await signer.getAddress()) as `0x${string}`;\n      const startTimestamp = _timestampNow();\n      const durationDays = 365;\n      const eip712 = instance.createEIP712(\n        publicKey,\n        contractAddresses,\n        startTimestamp,\n        durationDays\n      );\n      const signature = await signer.signTypedData(\n        eip712.domain,\n        { UserDecryptRequestVerification: eip712.types.UserDecryptRequestVerification },\n        eip712.message\n      );\n      return new FhevmDecryptionSignature({\n        publicKey,\n        privateKey,\n        contractAddresses: contractAddresses as `0x${string}`[],\n        startTimestamp,\n        durationDays,\n        signature,\n        eip712: eip712 as EIP712Type,\n        userAddress,\n      });\n    } catch {\n      return null;\n    }\n  }\n\n  static async loadOrSign(\n    instance: FhevmInstance,\n    contractAddresses: string[],\n    signer: ethers.Signer,\n    storage: GenericStringStorage,\n    keyPair?: { publicKey: string; privateKey: string }\n  ): Promise<FhevmDecryptionSignature | null> {\n    const userAddress = (await signer.getAddress()) as `0x${string}`;\n\n    const cached: FhevmDecryptionSignature | null =\n      await FhevmDecryptionSignature.loadFromGenericStringStorage(\n        storage,\n        instance,\n        contractAddresses,\n        userAddress,\n        keyPair?.publicKey\n      );\n\n    if (cached) {\n      return cached;\n    }\n\n    const { publicKey, privateKey } = keyPair ?? instance.generateKeypair();\n\n    const sig = await FhevmDecryptionSignature.new(\n      instance,\n      contractAddresses,\n      publicKey,\n      privateKey,\n      signer\n    );\n\n    if (!sig) {\n      return null;\n    }\n\n    await sig.saveToGenericStringStorage(\n      storage,\n      instance,\n      Boolean(keyPair?.publicKey)\n    );\n\n    return sig;\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 960, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/abi/PowerUsageABI.ts"],"sourcesContent":["\n/*\n  This file is auto-generated.\n  Command: 'npm run genabi'\n*/\nexport const PowerUsageABI = {\n  \"abi\": [\n    {\n      \"inputs\": [],\n      \"stateMutability\": \"nonpayable\",\n      \"type\": \"constructor\"\n    },\n    {\n      \"anonymous\": false,\n      \"inputs\": [\n        {\n          \"indexed\": true,\n          \"internalType\": \"uint256\",\n          \"name\": \"recordId\",\n          \"type\": \"uint256\"\n        },\n        {\n          \"indexed\": true,\n          \"internalType\": \"address\",\n          \"name\": \"owner\",\n          \"type\": \"address\"\n        },\n        {\n          \"indexed\": false,\n          \"internalType\": \"uint256\",\n          \"name\": \"timestamp\",\n          \"type\": \"uint256\"\n        },\n        {\n          \"indexed\": false,\n          \"internalType\": \"uint256\",\n          \"name\": \"period\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"name\": \"PowerRecordAdded\",\n      \"type\": \"event\"\n    },\n    {\n      \"anonymous\": false,\n      \"inputs\": [\n        {\n          \"indexed\": true,\n          \"internalType\": \"uint256\",\n          \"name\": \"recordId\",\n          \"type\": \"uint256\"\n        },\n        {\n          \"indexed\": true,\n          \"internalType\": \"address\",\n          \"name\": \"requester\",\n          \"type\": \"address\"\n        }\n      ],\n      \"name\": \"PowerRecordRetrieved\",\n      \"type\": \"event\"\n    },\n    {\n      \"inputs\": [\n        {\n          \"internalType\": \"externalEuint32\",\n          \"name\": \"encryptedUsageInput\",\n          \"type\": \"bytes32\"\n        },\n        {\n          \"internalType\": \"bytes\",\n          \"name\": \"inputProof\",\n          \"type\": \"bytes\"\n        },\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"period\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"name\": \"addRecord\",\n      \"outputs\": [\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"recordId\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"stateMutability\": \"nonpayable\",\n      \"type\": \"function\"\n    },\n    {\n      \"inputs\": [\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"recordId\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"name\": \"getRecordMetadata\",\n      \"outputs\": [\n        {\n          \"internalType\": \"address\",\n          \"name\": \"owner\",\n          \"type\": \"address\"\n        },\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"timestamp\",\n          \"type\": \"uint256\"\n        },\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"period\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"stateMutability\": \"view\",\n      \"type\": \"function\"\n    },\n    {\n      \"inputs\": [\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"recordId\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"name\": \"getRecordUsage\",\n      \"outputs\": [\n        {\n          \"internalType\": \"euint32\",\n          \"name\": \"encryptedUsage\",\n          \"type\": \"bytes32\"\n        }\n      ],\n      \"stateMutability\": \"view\",\n      \"type\": \"function\"\n    },\n    {\n      \"inputs\": [],\n      \"name\": \"getTotalRecords\",\n      \"outputs\": [\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"count\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"stateMutability\": \"view\",\n      \"type\": \"function\"\n    },\n    {\n      \"inputs\": [\n        {\n          \"internalType\": \"address\",\n          \"name\": \"user\",\n          \"type\": \"address\"\n        },\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"index\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"name\": \"getUserRecordByIndex\",\n      \"outputs\": [\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"recordId\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"stateMutability\": \"view\",\n      \"type\": \"function\"\n    },\n    {\n      \"inputs\": [\n        {\n          \"internalType\": \"address\",\n          \"name\": \"user\",\n          \"type\": \"address\"\n        }\n      ],\n      \"name\": \"getUserRecordCount\",\n      \"outputs\": [\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"count\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"stateMutability\": \"view\",\n      \"type\": \"function\"\n    },\n    {\n      \"inputs\": [\n        {\n          \"internalType\": \"address\",\n          \"name\": \"user\",\n          \"type\": \"address\"\n        }\n      ],\n      \"name\": \"getUserRecords\",\n      \"outputs\": [\n        {\n          \"internalType\": \"uint256[]\",\n          \"name\": \"recordIds\",\n          \"type\": \"uint256[]\"\n        }\n      ],\n      \"stateMutability\": \"view\",\n      \"type\": \"function\"\n    },\n    {\n      \"inputs\": [],\n      \"name\": \"protocolId\",\n      \"outputs\": [\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"stateMutability\": \"pure\",\n      \"type\": \"function\"\n    },\n    {\n      \"inputs\": [\n        {\n          \"internalType\": \"uint256\",\n          \"name\": \"recordId\",\n          \"type\": \"uint256\"\n        }\n      ],\n      \"name\": \"recordExists\",\n      \"outputs\": [\n        {\n          \"internalType\": \"bool\",\n          \"name\": \"exists\",\n          \"type\": \"bool\"\n        }\n      ],\n      \"stateMutability\": \"view\",\n      \"type\": \"function\"\n    }\n  ]\n} as const;\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1214, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/abi/PowerUsageAddresses.ts"],"sourcesContent":["\n/*\n  This file is auto-generated.\n  Command: 'npm run genabi'\n*/\nexport const PowerUsageAddresses = { \n  \"11155111\": { address: \"0x12D41ef4594ee82C9a698aC4078E0A67AA9dc743\", chainId: 11155111, chainName: \"sepolia\" },\n  \"31337\": { address: \"0x5FbDB2315678afecb367f032d93F642f64180aa3\", chainId: 31337, chainName: \"hardhat\" },\n};\n"],"names":[],"mappings":"AACA;;;AAGA;;;;AACO,MAAM,sBAAsB;IACjC,YAAY;QAAE,SAAS;QAA8C,SAAS;QAAU,WAAW;IAAU;IAC7G,SAAS;QAAE,SAAS;QAA8C,SAAS;QAAO,WAAW;IAAU;AACzG","debugId":null}},
    {"offset": {"line": 1237, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/hooks/usePowerUsage.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { ethers } from \"ethers\";\r\nimport {\r\n  RefObject,\r\n  useCallback,\r\n  useEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n} from \"react\";\r\n\r\nimport { FhevmInstance } from \"@/fhevm/fhevmTypes\";\r\nimport { FhevmDecryptionSignature } from \"@/fhevm/FhevmDecryptionSignature\";\r\nimport { GenericStringStorage } from \"@/fhevm/GenericStringStorage\";\r\n\r\n// These will be generated by genabi script after deployment\r\n// Try to import generated files, fallback to placeholder if not available\r\nlet PowerUsageABI_Module: any;\r\nlet PowerUsageAddresses_Module: any;\r\n\r\ntry {\r\n  PowerUsageABI_Module = require(\"@/abi/PowerUsageABI\");\r\n  PowerUsageAddresses_Module = require(\"@/abi/PowerUsageAddresses\");\r\n} catch {\r\n  // Files not generated yet - will be available after deployment and genabi\r\n  PowerUsageABI_Module = { PowerUsageABI: { abi: [] } };\r\n  PowerUsageAddresses_Module = { PowerUsageAddresses: {} };\r\n}\r\n\r\ntype PowerUsageABI = any[];\r\ntype PowerUsageAddresses = Record<string, { address: string; chainId: number; chainName?: string }>;\r\n\r\nconst PowerUsageABI_Data = PowerUsageABI_Module.PowerUsageABI?.abi || [];\r\nconst PowerUsageAddresses_Data = PowerUsageAddresses_Module.PowerUsageAddresses || {};\r\n\r\nexport type PowerRecord = {\r\n  recordId: number;\r\n  encryptedUsage: string;\r\n  timestamp: number;\r\n  period: number;\r\n  decryptedValue?: number;\r\n};\r\n\r\ntype PowerUsageInfoType = {\r\n  abi: PowerUsageABI;\r\n  address?: `0x${string}`;\r\n  chainId?: number;\r\n  chainName?: string;\r\n};\r\n\r\nfunction getPowerUsageByChainId(\r\n  chainId: number | undefined\r\n): PowerUsageInfoType {\r\n  if (!chainId) {\r\n    return { abi: PowerUsageABI_Data };\r\n  }\r\n\r\n  const entry = PowerUsageAddresses_Data[chainId.toString()];\r\n\r\n  if (!entry || entry.address === ethers.ZeroAddress) {\r\n    return { abi: PowerUsageABI_Data, chainId };\r\n  }\r\n\r\n  return {\r\n    address: entry.address as `0x${string}` | undefined,\r\n    chainId: entry.chainId ?? chainId,\r\n    chainName: entry.chainName,\r\n    abi: PowerUsageABI_Data,\r\n  };\r\n}\r\n\r\nexport const usePowerUsage = (parameters: {\r\n  instance: FhevmInstance | undefined;\r\n  fhevmDecryptionSignatureStorage: GenericStringStorage;\r\n  chainId: number | undefined;\r\n  ethersSigner: ethers.JsonRpcSigner | undefined;\r\n  ethersReadonlyProvider: ethers.ContractRunner | undefined;\r\n  sameChain: RefObject<(chainId: number | undefined) => boolean>;\r\n  sameSigner: RefObject<\r\n    (ethersSigner: ethers.JsonRpcSigner | undefined) => boolean\r\n  >;\r\n  userAddress?: string; // Add userAddress as a stable dependency\r\n}) => {\r\n  const {\r\n    instance,\r\n    fhevmDecryptionSignatureStorage,\r\n    chainId,\r\n    ethersSigner,\r\n    ethersReadonlyProvider,\r\n    sameChain,\r\n    sameSigner,\r\n    userAddress,\r\n  } = parameters;\r\n\r\n  const [records, setRecords] = useState<PowerRecord[]>([]);\r\n  const [isLoading, setIsLoading] = useState<boolean>(false);\r\n  const [isSubmitting, setIsSubmitting] = useState<boolean>(false);\r\n  const [isDecrypting, setIsDecrypting] = useState<number | null>(null);\r\n  const [message, setMessage] = useState<string>(\"\");\r\n\r\n  const powerUsageRef = useRef<PowerUsageInfoType | undefined>(undefined);\r\n  const isLoadingRef = useRef<boolean>(false);\r\n  const isSubmittingRef = useRef<boolean>(false);\r\n\r\n  const powerUsage = useMemo(() => {\r\n    const c = getPowerUsageByChainId(chainId);\r\n    powerUsageRef.current = c;\r\n    if (!c.address) {\r\n      setMessage(`PowerUsage deployment not found for chainId=${chainId}.`);\r\n    }\r\n    return c;\r\n  }, [chainId]);\r\n\r\n  const isDeployed = useMemo(() => {\r\n    if (!powerUsage) {\r\n      return undefined;\r\n    }\r\n    return Boolean(powerUsage.address) && powerUsage.address !== ethers.ZeroAddress;\r\n  }, [powerUsage]);\r\n\r\n  const canSubmit = useMemo(() => {\r\n    // Check if all required components are available\r\n    const hasAddress = Boolean(powerUsage.address && powerUsage.address !== ethers.ZeroAddress);\r\n    // Don't require instance here - we'll check it in submitRecord\r\n    // This allows button to be enabled even if FHEVM is still initializing\r\n    const hasSigner = ethersSigner !== undefined && ethersSigner !== null;\r\n    const notBusy = !isSubmitting && !isLoading;\r\n    \r\n    const result = hasAddress && hasSigner && notBusy;\r\n    return result;\r\n  }, [powerUsage.address, ethersSigner, isSubmitting, isLoading]);\r\n\r\n  const canLoadRecords = useMemo(() => {\r\n    return powerUsage.address && ethersReadonlyProvider && ethersSigner && !isLoading;\r\n  }, [powerUsage.address, ethersReadonlyProvider, ethersSigner, isLoading]);\r\n\r\n  const hasLoadedRef = useRef(false);\r\n  const lastAddressRef = useRef<string | undefined>(undefined);\r\n\r\n  const loadUserRecords = useCallback(async () => {\r\n    if (isLoadingRef.current) return;\r\n\r\n    if (!powerUsageRef.current?.address || !ethersReadonlyProvider || !ethersSigner) {\r\n      return;\r\n    }\r\n\r\n    isLoadingRef.current = true;\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      const contract = new ethers.Contract(\r\n        powerUsageRef.current.address,\r\n        powerUsageRef.current.abi,\r\n        ethersReadonlyProvider\r\n      );\r\n\r\n      // Ensure signer is available and get address\r\n      if (!ethersSigner) {\r\n        setMessage(\"Signer not available\");\r\n        return;\r\n      }\r\n\r\n      const userAddress = await ethersSigner.getAddress();\r\n      const recordIds = await contract.getUserRecords(userAddress);\r\n      const recordCount = recordIds.length;\r\n\r\n      const loadedRecords: PowerRecord[] = [];\r\n\r\n      for (let i = 0; i < recordCount; i++) {\r\n        const recordId = Number(recordIds[i]);\r\n        const [owner, timestamp, period] = await contract.getRecordMetadata(recordId);\r\n        const encryptedUsage = await contract.getRecordUsage(recordId);\r\n\r\n        loadedRecords.push({\r\n          recordId,\r\n          encryptedUsage,\r\n          timestamp: Number(timestamp),\r\n          period: Number(period),\r\n        });\r\n      }\r\n\r\n      setRecords(loadedRecords);\r\n      hasLoadedRef.current = true;\r\n      lastAddressRef.current = userAddress;\r\n    } catch (e) {\r\n      setMessage(\"Failed to load records: \" + e);\r\n    } finally {\r\n      isLoadingRef.current = false;\r\n      setIsLoading(false);\r\n    }\r\n  }, [ethersReadonlyProvider, ethersSigner]);\r\n\r\n  // Only auto-load once when wallet connects or address changes\r\n  useEffect(() => {\r\n    if (!canLoadRecords || !userAddress) {\r\n      hasLoadedRef.current = false;\r\n      lastAddressRef.current = undefined;\r\n      return;\r\n    }\r\n\r\n    const addressChanged = lastAddressRef.current !== userAddress;\r\n    const shouldLoad = !hasLoadedRef.current || addressChanged;\r\n\r\n    if (shouldLoad && !isLoadingRef.current) {\r\n      lastAddressRef.current = userAddress;\r\n      const timer = setTimeout(() => {\r\n        loadUserRecords();\r\n      }, 1000); // Wait 1 second after connection\r\n      return () => clearTimeout(timer);\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [powerUsage.address, userAddress]); // Only depend on contract address and user address\r\n\r\n  const submitRecord = useCallback(\r\n    async (powerUsageValue: number, period: number) => {\r\n      if (isSubmittingRef.current || isLoadingRef.current) return;\r\n\r\n      if (!powerUsage.address || !ethersSigner || powerUsageValue <= 0) {\r\n        setMessage(\"Missing required components for submission\");\r\n        return;\r\n      }\r\n\r\n      // Check instance at submission time\r\n      if (!instance) {\r\n        setMessage(\"FHEVM instance is not ready yet. Please wait...\");\r\n        return;\r\n      }\r\n\r\n      const thisChainId = chainId;\r\n      const thisPowerUsageAddress = powerUsage.address;\r\n      const thisEthersSigner = ethersSigner;\r\n\r\n      isSubmittingRef.current = true;\r\n      setIsSubmitting(true);\r\n      setMessage(`Encrypting and submitting ${powerUsageValue} kWh...`);\r\n\r\n      const run = async () => {\r\n        const isStale = async () => {\r\n          if (thisPowerUsageAddress !== powerUsageRef.current?.address) return true;\r\n          if (!sameChain.current(thisChainId)) return true;\r\n          const same = await sameSigner.current(thisEthersSigner);\r\n          return !same;\r\n        };\r\n\r\n        try {\r\n          await new Promise((resolve) => setTimeout(resolve, 100));\r\n\r\n          // Ensure signer is available and get address\r\n          if (!thisEthersSigner) {\r\n            setMessage(\"Signer not available\");\r\n            return;\r\n          }\r\n\r\n          const signerAddress = await thisEthersSigner.getAddress();\r\n          const input = instance.createEncryptedInput(\r\n            thisPowerUsageAddress,\r\n            signerAddress\r\n          );\r\n          // Convert float to integer (multiply by 100 to preserve 2 decimal places)\r\n          // e.g., 150.9 kWh -> 15090 (stored as integer)\r\n          const usageValueInt = Math.round(powerUsageValue * 100);\r\n          input.add32(usageValueInt);\r\n\r\n          const enc = await input.encrypt();\r\n\r\n          if (await isStale()) {\r\n            setMessage(\"Operation cancelled\");\r\n            return;\r\n          }\r\n\r\n          setMessage(\"Submitting to blockchain...\");\r\n\r\n          const contract = new ethers.Contract(\r\n            thisPowerUsageAddress,\r\n            powerUsage.abi,\r\n            thisEthersSigner\r\n          );\r\n\r\n          const tx = await contract.addRecord(\r\n            enc.handles[0],\r\n            enc.inputProof,\r\n            period\r\n          );\r\n\r\n          setMessage(`Waiting for transaction: ${tx.hash}...`);\r\n          await tx.wait();\r\n\r\n          setMessage(\"Record submitted successfully!\");\r\n          await loadUserRecords();\r\n        } catch (e: any) {\r\n          const errorMessage = e?.message || String(e);\r\n          // Check if it's a relayer connection error\r\n          if (errorMessage.includes(\"Relayer\") || errorMessage.includes(\"relayer\") || errorMessage.includes(\"Bad JSON\")) {\r\n            setMessage(\"Relayer service temporarily unavailable. Please try again in a few moments. If the problem persists, check Zama community status.\");\r\n          } else {\r\n            setMessage(\"Failed to submit record: \" + errorMessage);\r\n          }\r\n        } finally {\r\n          isSubmittingRef.current = false;\r\n          setIsSubmitting(false);\r\n        }\r\n      };\r\n\r\n      run();\r\n    },\r\n    [\r\n      powerUsage.address,\r\n      powerUsage.abi,\r\n      instance,\r\n      ethersSigner,\r\n      chainId,\r\n      loadUserRecords,\r\n      sameChain,\r\n      sameSigner,\r\n    ]\r\n  );\r\n\r\n  const decryptRecord = useCallback(\r\n    async (recordId: number) => {\r\n      if (!powerUsage.address || !instance || !ethersSigner) return;\r\n\r\n      const record = records.find((r) => r.recordId === recordId);\r\n      if (!record || record.encryptedUsage === ethers.ZeroHash) return;\r\n\r\n      setIsDecrypting(recordId);\r\n      setMessage(`Decrypting record ${recordId}...`);\r\n\r\n      try {\r\n        const sig: FhevmDecryptionSignature | null =\r\n          await FhevmDecryptionSignature.loadOrSign(\r\n            instance,\r\n            [powerUsage.address as `0x${string}`],\r\n            ethersSigner,\r\n            fhevmDecryptionSignatureStorage\r\n          );\r\n\r\n        if (!sig) {\r\n          setMessage(\"Unable to build decryption signature\");\r\n          return;\r\n        }\r\n\r\n        const res = await instance.userDecrypt(\r\n          [{ handle: record.encryptedUsage, contractAddress: powerUsage.address }],\r\n          sig.privateKey,\r\n          sig.publicKey,\r\n          sig.signature,\r\n          sig.contractAddresses,\r\n          sig.userAddress,\r\n          sig.startTimestamp,\r\n          sig.durationDays\r\n        );\r\n\r\n        // Convert integer back to float (divide by 100)\r\n        // e.g., 15090 -> 150.9 kWh\r\n        const decryptedValueInt = Number(res[record.encryptedUsage]);\r\n        const decryptedValue = decryptedValueInt / 100;\r\n\r\n        setRecords((prev) =>\r\n          prev.map((r) =>\r\n            r.recordId === recordId ? { ...r, decryptedValue } : r\r\n          )\r\n        );\r\n\r\n        setMessage(`Decrypted: ${decryptedValue} kWh`);\r\n      } catch (e) {\r\n        setMessage(\"Failed to decrypt: \" + e);\r\n      } finally {\r\n        setIsDecrypting(null);\r\n      }\r\n    },\r\n    [powerUsage.address, instance, ethersSigner, records, fhevmDecryptionSignatureStorage]\r\n  );\r\n\r\n  return {\r\n    contractAddress: powerUsage.address,\r\n    records,\r\n    canSubmit,\r\n    canLoadRecords,\r\n    submitRecord,\r\n    decryptRecord,\r\n    loadUserRecords,\r\n    isLoading,\r\n    isSubmitting,\r\n    isDecrypting,\r\n    message,\r\n    isDeployed,\r\n  };\r\n};\r\n\r\n\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1537, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/components/ErrorNotDeployed.tsx"],"sourcesContent":["export function errorNotDeployed(chainId: number | undefined) {\r\n  return (\r\n    <div className=\"grid w-full gap-4 mx-auto font-semibold bg-none\">\r\n      <div className=\"col-span-full mx-20\">\r\n        <p className=\"text-4xl leading-relaxed\">\r\n          {\" \"}\r\n          <span className=\"font-mono bg-red-500\">Error</span>:{\" \"}\r\n          <span className=\"font-mono bg-white\">PowerUsage.sol</span> Contract\r\n          Not Deployed on{\" \"}\r\n          <span className=\"font-mono bg-white\">chainId={chainId}</span>{\" \"}\r\n          {chainId === 11155111 ? \"(Sepolia)\" : \"\"} or Deployment Address\r\n          Missing.\r\n        </p>\r\n        <p className=\"text-xl leading-relaxed mt-8\">\r\n          It appears that the{\" \"}\r\n          <span className=\"font-mono bg-white\">PowerUsage.sol</span> contract\r\n          has either not been deployed yet, or the deployment address is missing\r\n          from the ABI directory{\" \"}\r\n          <span className=\"font-mono bg-white\">frontend/abi</span>. To\r\n          deploy <span className=\"font-mono bg-white\">PowerUsage.sol</span> on\r\n          Sepolia, run the following command:\r\n        </p>\r\n        <p className=\"font-mono text-2xl leading-relaxed bg-black text-white p-4 mt-12\">\r\n          <span className=\"opacity-50 italic text-red-500\">\r\n            #from pro26 directory\r\n          </span>\r\n          <br />\r\n          npx hardhat deploy --network{\" \"}\r\n          {chainId === 11155111 ? \"sepolia\" : \"localhost\"}\r\n        </p>\r\n        <p className=\"text-xl leading-relaxed mt-12\">\r\n          Alternatively, switch to the local{\" \"}\r\n          <span className=\"font-mono bg-white\">Hardhat Node</span> using the\r\n          Rainbow wallet browser extension.\r\n        </p>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;AAAO,SAAS,iBAAiB,OAA2B;IAC1D,qBACE,0PAAC;QAAI,WAAU;kBACb,cAAA,0PAAC;YAAI,WAAU;;8BACb,0PAAC;oBAAE,WAAU;;wBACV;sCACD,0PAAC;4BAAK,WAAU;sCAAuB;;;;;;wBAAY;wBAAE;sCACrD,0PAAC;4BAAK,WAAU;sCAAqB;;;;;;wBAAqB;wBAC1C;sCAChB,0PAAC;4BAAK,WAAU;;gCAAqB;gCAAS;;;;;;;wBAAgB;wBAC7D,YAAY,WAAW,cAAc;wBAAG;;;;;;;8BAG3C,0PAAC;oBAAE,WAAU;;wBAA+B;wBACtB;sCACpB,0PAAC;4BAAK,WAAU;sCAAqB;;;;;;wBAAqB;wBAEnC;sCACvB,0PAAC;4BAAK,WAAU;sCAAqB;;;;;;wBAAmB;sCACjD,0PAAC;4BAAK,WAAU;sCAAqB;;;;;;wBAAqB;;;;;;;8BAGnE,0PAAC;oBAAE,WAAU;;sCACX,0PAAC;4BAAK,WAAU;sCAAiC;;;;;;sCAGjD,0PAAC;;;;;wBAAK;wBACuB;wBAC5B,YAAY,WAAW,YAAY;;;;;;;8BAEtC,0PAAC;oBAAE,WAAU;;wBAAgC;wBACR;sCACnC,0PAAC;4BAAK,WAAU;sCAAqB;;;;;;wBAAmB;;;;;;;;;;;;;;;;;;AAMlE","debugId":null}},
    {"offset": {"line": 1693, "column": 0}, "map": {"version":3,"sources":["file:///C:/KS-Ku/demo26/pro26/frontend/components/PowerUsageDemo.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useState, useEffect, useRef, useMemo } from \"react\";\r\nimport { useAccount, useChainId, usePublicClient } from \"wagmi\";\r\nimport { ConnectButton } from \"@rainbow-me/rainbowkit\";\r\nimport { BrowserProvider } from \"ethers\";\r\nimport { useFhevm } from \"../fhevm/useFhevm\";\r\nimport { useInMemoryStorage } from \"../hooks/useInMemoryStorage\";\r\nimport { useEthersSigner } from \"../hooks/useEthersSigner\";\r\nimport { usePowerUsage } from \"@/hooks/usePowerUsage\";\r\nimport { errorNotDeployed } from \"./ErrorNotDeployed\";\r\n\r\nexport const PowerUsageDemo = () => {\r\n  const [mounted, setMounted] = useState(false);\r\n  const { address, isConnected } = useAccount();\r\n  const chainId = useChainId();\r\n  const publicClient = usePublicClient();\r\n  const { data: walletClient } = useAccount();\r\n  \r\n  const { storage: fhevmDecryptionSignatureStorage } = useInMemoryStorage();\r\n  const ethersSigner = useEthersSigner({ chainId });\r\n  \r\n  const [powerUsageValue, setPowerUsageValue] = useState<string>(\"\");\r\n  const [period, setPeriod] = useState<string>(\"\");\r\n\r\n  // Ensure component only renders after client-side hydration\r\n  useEffect(() => {\r\n    setMounted(true);\r\n  }, []);\r\n\r\n  // Convert wagmi provider to ethers provider\r\n  const ethersReadonlyProvider = publicClient ? new BrowserProvider(publicClient as any) : undefined;\r\n\r\n  const sameChainRef = useRef((cid: number | undefined) => cid === chainId);\r\n  const sameSignerRef = useRef(async (signer: any) => {\r\n    if (!signer || !address) return false;\r\n    try {\r\n      const signerAddress = await signer.getAddress();\r\n      return signerAddress.toLowerCase() === address.toLowerCase();\r\n    } catch {\r\n      return false;\r\n    }\r\n  });\r\n\r\n  // For local network, use publicClient if available, otherwise use walletClient\r\n  // FHEVM needs a provider that can make RPC calls\r\n  const fhevmProvider = useMemo(() => {\r\n    if (!isConnected || !chainId) return undefined;\r\n    \r\n    // For local hardhat network (chainId 31337), use publicClient\r\n    if (chainId === 31337 && publicClient) {\r\n      return (publicClient as any).transport;\r\n    }\r\n    \r\n    // For other networks, try walletClient first, then publicClient\r\n    if (walletClient?.transport) {\r\n      return (walletClient as any).transport;\r\n    }\r\n    \r\n    if (publicClient) {\r\n      return (publicClient as any).transport;\r\n    }\r\n    \r\n    return undefined;\r\n  }, [isConnected, chainId, walletClient, publicClient]);\r\n\r\n  const {\r\n    instance: fhevmInstance,\r\n    status: fhevmStatus,\r\n    error: fhevmError,\r\n  } = useFhevm({\r\n    provider: fhevmProvider,\r\n    chainId,\r\n    initialMockChains: { 31337: \"http://localhost:8545\" },\r\n    enabled: isConnected && chainId !== undefined,\r\n  });\r\n\r\n  const powerUsage = usePowerUsage({\r\n    instance: fhevmInstance,\r\n    fhevmDecryptionSignatureStorage,\r\n    chainId,\r\n    ethersSigner: ethersSigner as any,\r\n    ethersReadonlyProvider: ethersReadonlyProvider as any,\r\n    sameChain: sameChainRef,\r\n    sameSigner: sameSignerRef,\r\n    userAddress: address, // Pass stable address as dependency\r\n  });\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    const value = parseFloat(powerUsageValue);\r\n    const periodNum = parseInt(period) || 1;\r\n\r\n    if (isNaN(value) || value <= 0) {\r\n      alert(\"Please enter a valid power usage value (kWh)\");\r\n      return;\r\n    }\r\n\r\n    await powerUsage.submitRecord(value, periodNum);\r\n    setPowerUsageValue(\"\");\r\n    setPeriod(\"\");\r\n  };\r\n\r\n  const buttonClass =\r\n    \"inline-flex items-center justify-center rounded-xl bg-blue-600 px-4 py-2 font-semibold text-white shadow-sm \" +\r\n    \"transition-colors duration-200 hover:bg-blue-700 active:bg-blue-800 \" +\r\n    \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 \" +\r\n    \"disabled:opacity-50 disabled:pointer-events-none\";\r\n\r\n  // Show loading state during SSR and initial hydration\r\n  if (!mounted) {\r\n    return (\r\n      <div className=\"mx-auto text-center py-8\">\r\n        <div className=\"animate-pulse\">\r\n          <div className=\"h-8 bg-gray-200 rounded w-64 mx-auto mb-4\"></div>\r\n          <div className=\"h-4 bg-gray-200 rounded w-96 mx-auto\"></div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!isConnected) {\r\n    return (\r\n      <div className=\"mx-auto text-center\">\r\n        <h2 className=\"text-2xl font-bold mb-4\">Connect Your Wallet</h2>\r\n        <p className=\"text-gray-600 mb-6\">Connect your wallet to start logging your power usage</p>\r\n        <ConnectButton />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (powerUsage.isDeployed === false) {\r\n    return errorNotDeployed(chainId);\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid w-full gap-6 max-w-4xl mx-auto px-4\">\r\n      <div className=\"bg-white rounded-lg shadow-lg p-6\">\r\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">\r\n          Encrypted Power Usage Log\r\n        </h1>\r\n        <p className=\"text-gray-600 mb-6\">\r\n          Record your household power usage with encrypted privacy protection\r\n        </p>\r\n\r\n        <form onSubmit={handleSubmit} className=\"mb-6\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4\">\r\n            <div>\r\n              <label htmlFor=\"powerUsage\" className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Power Usage (kWh)\r\n              </label>\r\n              <input\r\n                id=\"powerUsage\"\r\n                type=\"number\"\r\n                step=\"0.01\"\r\n                min=\"0\"\r\n                value={powerUsageValue}\r\n                onChange={(e) => setPowerUsageValue(e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                placeholder=\"150.5\"\r\n                required\r\n              />\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"period\" className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Period (Day/Month)\r\n              </label>\r\n              <input\r\n                id=\"period\"\r\n                type=\"number\"\r\n                min=\"1\"\r\n                value={period}\r\n                onChange={(e) => setPeriod(e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                placeholder=\"1\"\r\n              />\r\n            </div>\r\n            <div className=\"flex items-end\">\r\n              <button\r\n                type=\"submit\"\r\n                disabled={\r\n                  !powerUsage.canSubmit || \r\n                  powerUsage.isSubmitting || \r\n                  !powerUsageValue || \r\n                  isNaN(parseFloat(powerUsageValue)) ||\r\n                  parseFloat(powerUsageValue) <= 0\r\n                }\r\n                className={buttonClass + \" w-full\"}\r\n              >\r\n                {powerUsage.isSubmitting ? \"Submitting...\" : \"Submit Record\"}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </form>\r\n\r\n        {powerUsage.message && (\r\n          <div className=\"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md\">\r\n            <p className=\"text-sm text-blue-800\">{powerUsage.message}</p>\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"flex justify-between items-center mb-4\">\r\n          <h2 className=\"text-xl font-semibold text-gray-900\">Your Records</h2>\r\n          <button\r\n            onClick={powerUsage.loadUserRecords}\r\n            disabled={!powerUsage.canLoadRecords || powerUsage.isLoading}\r\n            className={buttonClass + \" text-sm px-3 py-1\"}\r\n          >\r\n            {powerUsage.isLoading ? \"Loading...\" : \"Refresh\"}\r\n          </button>\r\n        </div>\r\n\r\n        {powerUsage.records.length === 0 ? (\r\n          <div className=\"text-center py-8 text-gray-500\">\r\n            <p>No power usage records yet.</p>\r\n            <p className=\"text-sm mt-2\">Submit your first record above to get started.</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-3\">\r\n            {powerUsage.records.map((record) => (\r\n              <div\r\n                key={record.recordId}\r\n                className=\"border border-gray-200 rounded-lg p-4 hover:bg-gray-50\"\r\n              >\r\n                <div className=\"flex justify-between items-start\">\r\n                  <div className=\"flex-1\">\r\n                    <div className=\"flex items-center gap-4 mb-2\">\r\n                      <span className=\"font-semibold text-gray-900\">\r\n                        Record #{record.recordId}\r\n                      </span>\r\n                      <span className=\"text-sm text-gray-500\">\r\n                        Period: {record.period}\r\n                      </span>\r\n                      <span className=\"text-sm text-gray-500\">\r\n                        {new Date(record.timestamp * 1000).toLocaleDateString()}\r\n                      </span>\r\n                    </div>\r\n                    {record.decryptedValue !== undefined ? (\r\n                      <div className=\"mt-2\">\r\n                        <span className=\"text-lg font-bold text-green-600\">\r\n                          {record.decryptedValue.toString()} kWh\r\n                        </span>\r\n                        <span className=\"text-sm text-gray-500 ml-2\">(Decrypted)</span>\r\n                      </div>\r\n                    ) : (\r\n                      <div className=\"mt-2\">\r\n                        <span className=\"text-sm text-gray-500\">\r\n                          Encrypted value stored on-chain\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                  {record.decryptedValue === undefined && (\r\n                    <button\r\n                      onClick={() => powerUsage.decryptRecord(record.recordId)}\r\n                      disabled={powerUsage.isDecrypting === record.recordId}\r\n                      className={buttonClass + \" ml-4 text-sm px-3 py-1\"}\r\n                    >\r\n                      {powerUsage.isDecrypting === record.recordId\r\n                        ? \"Decrypting...\"\r\n                        : \"Decrypt\"}\r\n                    </button>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n\r\n"],"names":[],"mappings":"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","debugId":null}}]
}